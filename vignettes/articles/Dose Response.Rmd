---
title: "Dose Response Processing"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

**easyXpress** is an R package to read, process, and analyze worm morphology data acquired with the 
[`cellprofiler-nf nextflow pipeline`](https://github.com/AndersenLab/cellprofiler-nf). 

Below is a detailed walk through applying the easyXpress package to sample dose response data that were
extracted from a series of [toxicant dose responses published in the journal Toxicology](https://www.sciencedirect.com/science/article/pii/S0300483X22002049?via%3Dihub).

In general, there are four major steps to processing dose response data.

1. LOAD DATA: Read in CellProfiler data and select the appropriate models for primary objects.
2. FLAG OBJECTS: Flag, check, and filter problematic objects, then summarize object data within wells.
3. FLAG WELLS: Flag, check, and filter problematic wells, then check exprimental design balance after filtering.
4. FINALIZE RESULTS: Calculate control delta's and regress confounding effects if needed.

```{r setup}
library(easyXpress)
library(tidyverse)
```

### Get example dose response data

This article will use example data that exceeds the typical size for package vignettes, therefore users can pull the example data from a separate repository to recreate the workflow below.

To get the example data users will need to have `git` installed on their machine. [Follow instructions here if you don't have `git` installed or are unsure.](https://github.com/git-guides/install-git) 

```{r message=FALSE}
# specify a directory to clone the example data repository to. Here we'll clone it to the Desktop. You can use whatever path your like here, just make sure it is valid and ends in /
ex.dir <- "~/Desktop/" 

# clone the repo using a system command
system(paste0("git clone https://github.com/AndersenLab/eXDR.git ", ex.dir, "eXDR"))

```

## Load Data

Read in CellProfiler data and select the appropriate models for primary objects.

### `readXpress()`

This function reads data output from `cellprofiler-nf` into R.  

`readXpress()` takes one or more paths to project directories that hold data exported from `cellprofiler-nf`. Each project directory msut have CellProfiler data in a sub-folder named `cp_data`. Set the `rdafile` argument to the name of the files you plan to use, one per project. If `design = TRUE`, a design file will be joined. The design file should be located in a sub-folder of the experimental directory named `design`. If `design = FALSE`, no design file will be joined. To process dose response data, users must set `doseR = TRUE`. The other arguments are specified by default but can be adjusted if needed. 
  
For more information regarding project directory structure, see [`R/easyXpress`](https://github.com/AndersenLab/easyXpress).

If `design = T` the `readXpress()` function returns a list, with the first element named `raw_data` and the second named `design`.

```{r}
# make a vector of project directories cloned in the example data (eXDR)
filedirs <- c(paste0(ex.dir, "eXDR", "/20201210_toxin14A"),
            paste0(ex.dir, "eXDR", "/20201217_toxin15A"),
            paste0(ex.dir, "eXDR", "/20210311_toxin22A"))

# make a vector of the .RData files cloned in the example data (eXDR)
rdafiles <- c("20201210_toxin14A_Analysis-20231003.RData",
              "20201217_toxin15A_Analysis-20231003.RData",
              "20210311_toxin22A_Analysis-20231003.RData")

# Read in the data
dr <- easyXpress::readXpress(filedir = filedirs, rdafile = rdafiles, design = T, doseR = T)
```
### `modelSelection()`

`modelSelection()` takes the raw data output from the `readXpress()` function. 
It will assign the appropriate CellProfiler model to each primary object in the data frame.  

To access the raw data output from the `readXpress()` function call above, we can use `dr$raw_data`.

In this example, the data was generated using 4 worm models: MDHD, L1, L2L3, and L4, models.

```{r}
# Use the modelSelection function to select the best model for each primary object
ms <- easyXpress::modelSelection(dr$raw_data)
```

## Flag Objects

This part of the project processing will flag problematic objects in the data using various `ObjectFlag` functions (OFs). Next, users can filter flags or retain them after they have been checked.

Since all the object data is derived from images, the various `view` functions are used to annotate flag data in the image overlays output by `cellprofiler-nf`, which help determine which flags should be filtered or retained.

We recommend the `edgeOF()` and `clusterOF()` functions are applied before checking objects. After checking objects, we recommend setting custom flags with the `userOF` function, then applying the `classifierOF()` and `outlierOF()` functions before summarizing the filtered data with the  `summarizeWells()` function.

### edge and cluster OFs
```{r, fig.height = 12, fig.width = 12, fig.align = 'center'}
# Use the edge Object Flag (OF) function to flag objects close to the edge of the well
ef <- edgeOF(data = ms)

# Use the clusterOF function to flag objects that likely contain overlapping worms.
cf <- clusterOF(data = ef)

```

### check object flags
```{r, fig.height = 12, fig.width = 12, fig.align = 'center'}
# Let's check on the objects to see how the flags look across our desired grouping variables (...)
c1 <- checkOF(data = cf, drug, concentration_um)

# loop at the plot
c1$p
```
<br> The `checkOF` plot shows that there are a lot of objects and many clusters at the higher concentrations of Zinc, which suggests a problem at these concentrations.

```{r, fig.height = 12, fig.width = 12, fig.align = 'center', warning=FALSE}
# Let's  look at the size distributions of the objects by our grouping variables with the checkObjs function.

# Plot just the noFlag data by setting OF = "filter"
c2 <- checkObjs(data = cf, OF = 'filter', strain, drug, concentration_um)

# look at the plot object
c2
```
<br> The diagnostic plot made with the `checkObjs()` function shows a strong bimodal distribution in the higher concentrations of zinc that further suggest a problem - probably debris in wells.

### checkModels

Let's use the `checkModels()` function to see if the small objects in each drug are real worms or not. This function will produce diagnostic plots for drugs across grouping variables, use `?checkModels()` for more help.

```{r}
# # Before we can use the checkModels function we need to add a variable that specifies the PATH to the processed images for each project. This is common when data are pulled from 3 independent assays, like in this example. We can use dplyr to help us do that and make a nice label variable to include in our diagnostic overlays too.
# cm <- cf %>%
#   dplyr::mutate(i.dir = dplyr::case_when(Metadata_Experiment == "toxin14A" ~
#                                            paste0(ex.dir, "eXDR/20201210_toxin14A/processed_images/"),
#                                          Metadata_Experiment == "toxin15A" ~
#                                            paste0(ex.dir, "eXDR/20201217_toxin15A/processed_images/"),
#                                          Metadata_Experiment == "toxin22A" ~
#                                            paste0(ex.dir, "eXDR/20210311_toxin22A/processed_images/"),
#                                          TRUE ~ NA_character_), # add the proc.img.dir var
#                 w.lab = paste(drug, strain, concentration_um, sep = "_")) # add the well label var
# 
# # now we can use the checkModels function to look across the drugs and assays to see if we should use the MDHD model. Also, we can decide if we want to use a ~100um (30px) or ~165um (50px) size filter.
# cm.out <- checkModels(data = cm,
#                       Metadata_Experiment, drug, # grouping vars (...) to make a diagnostic plot for each.
#                       proc.img.dir = "i.dir",
#                       well.label = "w.lab",
#                       out.dir = paste0(ex.dir, "eXDR/checkModels/out"))
```

```{r fig.cap='checkModels() plot'}
knitr::include_graphics(path = "man/figures/checkModels_ex_anno.png")
```
<br> Based on the diagnostic plots from the `checkModels()` function it seems like we should:
1) filter the MDHD model for Zinc dichloride and use a 165um size threshold, see example above.
2) Use the MDHD model for paraquat, but filter out objects with a `worm_length_um` less than 165um, no example shown but you can see the plots in your example directory for yourself.

## Flag Wells

Flag, check, and filter problematic wells then check exprimental design balance after filtering.


## Finalize Results

Calculate control delta's and regress confounding effects if needed.
